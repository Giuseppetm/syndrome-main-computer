- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '18'
    cache: 'npm'

- name: Install dependencies
  run: npm ci

# 1. Next.js Build
- name: Build Next for production
  run: npm run build

# 2. Electron Transpile
- name: Transpile electron main to ESM (do NOT bundle)
  run: npx esbuild electron/main.ts --platform=node --target=node18 --outfile=electron/main.js --format=esm

# 3. Packaging
- name: Package Windows executable
  env:
    CSC_LINK: ${{ secrets.CSC_LINK || '' }}
    CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD || '' }}
  run: npx electron-builder --win --x64 --publish=never

- name: List dist contents
  run: dir .\\dist | Out-String

# 4. Create Release
- name: Create GitHub Release (from tag)
  if: startsWith(github.ref, 'refs/tags/')
  id: create_release
  uses: ncipollo/release-action@v1
  with:
    tag: ${{ github.ref_name }}
    name: Release ${{ github.ref_name }}
    body: 'Automated build: windows installer and exe'
    draft: false
    prerelease: false
    artifacts: 'dist/**/*'

# 5. Attach dist artifacts (fallback)
- name: Attach dist artifacts (fallback)
  if: always()
  uses: actions/upload-artifact@v4
  with:
    name: windows-dist
    path: dist/**
